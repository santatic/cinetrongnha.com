var FacebookAPI=function(a){this.app=a;this.setting={appid:"680287678695523",permission:"email read_stream publish_stream publish_actions offline_access user_checkins user_photos read_friendlists".split(" "),fields:"first_name,last_name,email,username,gender,picture,locale,id,link,quotes,bio,timezone"};this.userInfo={type:"facebook"};this.logined=this.connected=!1};
FacebookAPI.prototype={Init:function(a){var b=this;FB.init({appid:this.setting.appid,status:!0,cookie:!0,xfbml:!0,oauth:!0});FB.Event.subscribe("auth.authResponseChange",function(a){"connected"!=a.status||b.connected||(b.connected=!0,b.userInfo.access_token=a.authResponse.accessToken,b.userInfo.id=a.authResponse.userID,b.InfoUpdate())})},Login:function(){FB.login(function(a){console.debug(a)},perms.join(","))},InfoUpdate:function(){var a=this;FB.api("/me",{fields:this.setting.fields},function(b){"string"==
typeof b.username&&(a.userInfo.first_name=b.first_name,a.userInfo.last_name=b.last_name,a.userInfo.email=b.email,a.userInfo.username=b.username,a.userInfo.gender=b.gender,a.userInfo.locale=b.locale,a.userInfo.link=b.link,a.userInfo.picture=b.picture.data.url,a.userInfo.quotes=b.quotes,a.userInfo.bio=b.bio,a.userInfo.timezone=b.timezone,a.Logined())})},Logined:function(){var a=this;PageAjax({type:"post",url:"/login",data:a.userInfo}).done(function(b){"true"==b&&(a.app._Login.logined=!0)}).error(function(a){console.debug(a)})}};var Router=function(a){this.app=a;this.callback={};this.old_url=window.location.href.split("#",1)[0]};
Router.prototype={Init:function(){var a=this;$(window).bind("popstate",function(b){a.Goto(window.location.href,!1)})},Goto:function(a,b){var c=this;if("+"==a[0]){a=a.substring(1,a.length);var d=!0}a=$("<a>").attr("href",a)[0].href;if(1==d){try{var e=a.split("?",2)[1].split("#",1)[0]}catch(g){e=""}try{var f=this.old_url.split("?",2)[1].split("#",1)[0]}catch(k){f=""}e!=f&&(e=f+"&"+e,e=e.split("&"),params={},$.each(e,function(a,b){var c=b.split("=",2);2==c.length&&(params[c[0]]=c[1])}),e=[],$.each(params,
function(a,b){e.push(a+"="+b)}),e=e.join("&"),a=a.split("?",1)[0]+"?"+e)}if(a.split("#",1)[0]!=this.old_url.split("#",1)[0]&&(d=a.split("?",1)[0].split("/"),3<d.length)){f=d[3];d=this.old_url.split("?",1)[0].split("/")[3];b&&!1===b||this._pushState(a);$("body").scrollTop(0);this.old_url=a;if(this.callback.__global__)for(var h in this.callback.__global__)try{this.callback.__global__[h](a)}catch(m){console.error(m)}if(f==d){if(this.callback&&this.callback[f])for(h in this.callback[f])this.callback[f][h](a)}else(h=
$(".sites:first .site:first .page[page-name="+d+"]").data("page-object"))&&h.Close(),delete this.callback[d],c.app._ProcessBar.Reset(),c.app._ProcessBar.Run(40),PageAjax({url:a,type:"post",dataType:"json",data:{content:"page"}}).done(function(a){c.app._ProcessBar.Run(70);if(a.content){c.app._ProcessBar.Run(100);var b=$(".sites:first .site:first"),d=b.find(".pages:first");d.children().remove();var d=$(a.content).appendTo(d),e=new Page(c.app);e.Init(d);d.data("page-object",e);e.Refesh();a.graph&&(b=
b.data("site-object"))&&b.UpdateGraph(a.graph)}else c.app._ProcessBar.Run(100)}).error(function(a){console.error(a)})}},AddCallback:function(a,b){"function"==typeof b&&(void 0==this.callback&&(this.callback={}),null==a?(void 0==this.callback.__global__&&(this.callback.__global__=[]),this.callback.__global__.push(b)):(void 0==this.callback[a]&&(this.callback[a]=[]),this.callback[a].push(b)))},_pushState:function(a){history.pushState?history.pushState(null,null,a):window.location=a}};var Site=function(a){this.app=a};
Site.prototype={Init:function(a){var b=this;this.form=a;(new Header(this.app)).Init(this.form.find(".site-header:first"));page=this.form.find(".pages:first>.page:visible:first");$.each(page,function(a,b){var c=$(b);if(void 0==c.data("page-object")){var f=new Page(app);f.Init(c);c.data("page-object",f)}else c.data("page-object").Init(c)});$.each(page,function(a,b){var c=$(b).data("page-object");if(void 0!=c)try{c.Refesh()}catch(f){console.error(f)}});a=page.data("page-object");var c=b.form.find(".wrapper>.sidebar-wrapper .PageModule");
void 0!=a&&a.Init_Module(c);this.form.on("click","[site-goto]",function(a){a.preventDefault();a=$(this).attr("site-goto")+$(this).attr("href");b.app._Router.Goto(a)});$(window).on("beforeunload",function(){try{b.Close()}catch(a){}})},UpdateGraph:function(a){var b=$("head"),c;for(c in a){"og:title"==c&&b.find("title").html(a[c]);var d=b.find('meta[property="'+c+'"]');0<d.length?d.attr("content",a[c]):b.append('<meta property="'+c+'" content="'+a[c]+'"/>')}},Close:function(){var a=this.form.find(".pages .page").data("page-object");
void 0!=a&&a.Close()}};var app=this;$(document).ready(function(){app._Timer=new Timer(app);app._ProcessBar=new ProcessBar(app);app._Router=new Router(app);app._Login=new Login(app);app._Store=new Store(app);try{app._Store.Init(),app._Timer.Init(),app._ProcessBar.Init($(".site-process:first"),{}),app._Router.Init(),app._Login.Init()}catch(a){console.error(a)}var b=new Site(app),c=$(".site:first");b.Init(c);c.data("site-object",b)});var Store=function(a){this.app=a};
Store.prototype={Init:function(){localStorage&&(this.canstore=!0)},set:function(a,b){if(this.canstore){var c=$.type(b);if("array"==c||"object"==c)b=JSON.stringify(b);localStorage.setItem(a,JSON.stringify({data:b,type:c}))}},get:function(a){if(this.canstore&&(a=localStorage.getItem(a))){a=$.parseJSON(a);if("array"==a.type||"object"==a.type)a.data=$.parseJSON(a.data);return a.data}},append:function(a,b){var c=this.get(a);c&&"array"==$.type(c)?c.push(b):c=[b];this.set(c)},update:function(a,b){console.debug("update",
a,b);if("object"==$.type(b)){var c=this.get(a),c=c&&"object"==$.type(c)?$.extend(c,b):b;this.set(a,c)}}};var Page=function(a){this.app=a};
Page.prototype={Init:function(a,b){this.form=a;this.form.data("page-object",this);this.Refesh(["class"]);var c=this.form.find(".PageModule[module-name]");this.Init_Module(c);return this.form},Init_Module:function(a){$.each(a,function(a,c){var d=$(c);if(void 0==d.data("module-object")){var e="PageModule"+d.attr("module-name"),e=new window[e](app);"object"==typeof e&&(d.data("module-object",e),e.Init(d))}else d.data("module-object").Init(d)});$.each(a,function(a,c){var d=$(c).data("module-object");
d&&d.Refesh()})},Refesh:function(a){var b=this,c=this.form.find(".page-rows>.page-row[setting], .page-cols>.page-col[setting]");$.each(c,function(c,e){var g=$(e);try{var f=JSON.parse(Base64.decode(g.attr("setting")));if(a&&0<a.length){var k={},h;for(h in a)k[a[h]]=f[a[h]];f=k}b.UpdateSetting(g,f)}catch(m){console.debug(m)}})},UpdateSetting:function(a,b){b["class"]&&void 0==a.data("page-classed")&&(a.addClass(b["class"].join(" ")),a.data("page-classed",!0));if(b.affix&&b.affix&&void 0==a.data("page-affixed")){var c=
this.form.parents(".site:first").find(".site-header:first").outerHeight();a.addClass("page-affix");a.affix({offset:{top:function(){return this.top=a.offset().top-c}}});a.bind("affix.bs.affix",function(b){a.css({top:c,width:a.outerWidth()})});a.bind("affix-top.bs.affix affix-bottom.bs.affix",function(b){a.css({width:"",top:""})});a.data("page-affixed",!0)}},Close:function(){var a=this.form.find(".PageModule[module-id]");$.each(a,function(a,c){var d=$(c).data("module-object");if(d)try{d.Close()}catch(e){}})}};var Login=function(a){this.app=a};
Login.prototype={Init:function(){var a=this;$("body").on("click",".login-require",function(b){void 0==a.login.user_id&&(b.preventDefault(),b.stopPropagation(),a.Form("show"))});this.form=$('<div class="modal fade"role="dialog" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title">Login</h4></div><div class="modal-body"></div></div></div></div>').modal({show:!1});this.form.on("show.bs.modal",
function(b){try{void 0!=a.login.user_id?(a.form.find(".modal-body:first").html('<div class="fb-login-button" data-max-rows="1" data-size="large" data-show-faces="true" data-auto-logout-link="false"></div>'),FB.XFBML.parse(a.form[0])):a.form.find(".modal-body:first").html('<a href="/login/facebook?next='+window.location.pathname+'" class="btn btn-primary btn-block">Facebook Login</a>')}catch(d){console.error(d)}});var b=$("[site-login]:first").attr("site-login");a.login=$.parseJSON(Base64.decode(b))},
Form:function(a){"show"==a&&this.form.modal("show")},LoggedIn:function(){return void 0!=this.login.user_id?!0:!1}};var ProcessBar=function(a){this.app=a;this.setting={callback:function(){},percent:0}};
ProcessBar.prototype={Init:function(a,b){this.container=a;for(var c in b)this.setting[c]=b[c];this.pages=$("body .pages:first")},ContentView:function(a){"hide"==a?this.pages.css("opacity","0.3"):this.pages.css("opacity","1")},SetCallback:function(a){this.setting.callback=a},Reset:function(){this.ContentView("show");this.setting.percent=0;this.setting.callback=function(){};this.container.show()},Run:function(a){var b=this;this.ContentView("hide");this.container.stop().animate({property:a},{duration:100,
step:function(){var a=Math.round(this.property);b.container.css("width",a+"%")},complete:function(){100<=this.property&&(b.container.addClass("done"),this.property=0,setTimeout(function(){b.ContentView("show");b.container.hide();b.container.removeClass("done");b.container.css("width","0%")},100),b.setting.callback());b.setting.percent=a}})},Add:function(a){this.Run(this.setting.percent+a)}};var Header=function(a){this.app=a;this.setting={}};
Header.prototype={Init:function(a,b){var c=this;this.form=a;b=JSON.parse(Base64.decode(this.form.attr("header-setting")));for(var d in b)this.setting[d]=b[d];c.SearchBarInit();c.form.on("click",".nav a",function(a){c.form.find(".navbar-toggle:visible:first").not(".collapsed").click()});this.app._Router.AddCallback(null,function(a){var b=c.form.find(".nav.navbar-nav:first a");$.each(b,function(c,d){var h=$(d);a==h[0].href&&(b.removeClass("active"),h.addClass("active"))})});c.form.on("click",".navbar-toggle.menu-left",
function(a){$(".wrapper").toggleClass("left").removeClass("right");a.preventDefault()});this.form.on("click",".user-info",function(a){$(".wrapper").toggleClass("right").removeClass("left");a.preventDefault()});$(".wrapper").on("click","[wrapper-hide]",function(a){console.debug("removeClass left right",$(".wrapper"));$(".wrapper").removeClass("left")});c.Refesh()},Refesh:function(){var a=this;void 0!=a.setting["class"]&&$.each(a.setting["class"],function(b,c){var d=a.form.find("."+b);$.each(d,function(a,
b){var d=$(b);d.data("md-classed")||d.addClass(c).data("md-classed",!0)})})},SearchBarInit:function(){if(void 0!=this.setting.search){var a=this,b,c=a.form.find(".searchbar .result");a.form.on("keypress",".searchbar .text",function(d){void 0!=b&&clearTimeout(b);var g=$(this).val().trim();3<=g.length?(c.show(),a.form.find(".searchbar .result .loading").show(),a.form.find(".searchbar .result .content").hide(),b=setTimeout(function(b){a.SearchBarRun(g)},1500)):c.hide()});a.form.on("focusin",".searchbar .text",
function(b){3<=a.form.find(".searchbar .text").val().length&&c.show()}).on("focusout",".searchbar .text",function(a){setTimeout(function(){c.hide()},200)});var d=a.form.find(".searchbar");500<=d.width()?c.width(d.width()):c.width("100%").css({left:0})}},SearchBarRun:function(a){console.debug("search",a);var b=this;PageAjax({url:this.setting.search.replace("{{ TEXT }}",encodeURIComponent(a)),cache:!0,dataType:"json",type:"POST"}).done(function(a){if(void 0!=a.post){var d="";$.each(a.post,function(a,
b){d+='<a href="'+b.link+'" site-goto><div class="post border-left"><div class="img"><img src="'+b.poster+'"></div><div class="info"><div class="title">'+b.title+'</div><div class="subtitle">'+b.subtitle+'</div><div class="">...</div></div></div></a>'});b.form.find(".searchbar .result .loading").hide();b.form.find(".searchbar .result .content").show().find(".posts").html(d)}})}};function Module(a){this.app=a;this.setting={"class":{},trigger:{},onrouter:!0};this.template={};this.bind_list={}}
Module.prototype={Init:function(a){var b=this;if(void 0==b._inited)b._inited=!0;else return!0;b.form=a;try{var c=JSON.parse(Base64.decode(b.form.attr("module-setting")));b.setting=$.extend(b.setting,c)}catch(d){}(a=b.form.attr("module-template"))&&""!=a&&(b.template=JSON.parse(Base64.decode(a)));b.form.bind("view",function(a,c){if(c.type&&c.data&&b.bind_list[c.type])for(var d in b.bind_list[c.type])b.bind_list[c.type][d](c.data);a.preventDefault();a.stopPropagation()})},Trigger:function(a,b){if(this.setting.trigger[a]){var c=
this.form.parents(".page:first");$.each(this.setting.trigger[a],function(d,e){c.find("[module-id="+e+"]:first").trigger("view",{type:a,data:b})})}},Bind:function(a,b){this.bind_list[a]?this.bind_list[a].push(b):this.bind_list[a]=[b]},onRouter:function(a,b){1==this.setting.onrouter&&(void 0==b&&(b={}),this.app._Router.AddCallback(this.form.parents("[page-name]:first").attr("page-name"),function(c){var d={url:c};if(b.post){var e=c.match(/[a-z0-9]{24}/g);null!=e&&0<e.length&&(d.post=e[0])}if(b.param){d.param=
{};try{var g=c.split("?",2)[1].split("&"),f;for(f in g)l=g[f].split("="),d.param[l[0]]=l[1]}catch(k){}}a(d)}))},Load:function(a){var b=this;a=$.extend({query:{},callback:void 0,url:window.location.href,processbar:!0},a);b._ajax_loading=!0;a.query.module=b.form.attr("module-id");a.processbar&&(b.app._ProcessBar.Reset(),b.app._ProcessBar.Run(50));for(var c in a.query)"string"!=$.type(a.query[c])&&(a.query[c]=JSON.stringify(a.query[c]));PageAjax({url:a.url,type:"post",dataType:"json",data:a.query}).done(function(c){a.processbar&&
b.app._ProcessBar.Run(100);void 0==a.callback?(b.form.find(".loading").removeClass("loading"),c.post&&0<c.post.length?(b.form.find(".posts:first").append(b.Render("post",c.post)),b.Refesh()):b.form.find(".footer .btn").attr("disabled","disabled")):a.callback(c);if(c.graph){var e=b.form.parents(".site:first").data("site-object");e&&e.UpdateGraph(c.graph)}}).error(function(a){console.error(a)}).always(function(a){b._ajax_loading=!1})},Render:function(a,b){var c=this.template[a];"object"==$.type(b)&&
(b=[b]);var d="";$.each(b,function(a,b){var f=c;$.each(b,function(a,b){f=f.split("{{ "+a+" }}").join(b)});d+=f});return d},Refesh:function(){var a=this;a.setting["class"]&&$.each(a.setting["class"],function(b,c){var d=a.form.find("."+b);$.each(d,function(a,b){var d=$(b);d.data("md-classed")||d.addClass(c).data("md-classed",!0)})})},Close:function(){}};var Timer=function(a){this.app=a};
Timer.prototype={Init:function(){this.updatelist=[]},Add:function(a){"object"==typeof a&&(this.updatelist.push(a),this.UpdateTime(a))},Refesh:function(){$.each(this.updatelist,function(a,b){$(b).is(":visible")})},UpdateTime:function(a){var b=parseInt(a.attr("time")),c=Date.now()-b,d="";6E4>c?(d=new Date(c),d=d.getSeconds()+" gi\u00e2y tr\u01b0\u1edbc"):36E5>c?(d=new Date(c),d=d.getMinutes()+" ph\u00fat tr\u01b0\u1edbc"):864E5>c?(d=new Date(c),d=d.getHours()+" gi\u1edd tr\u01b0\u1edbc"):2592E6>c?(d=
new Date(c),d=d.getDate()+" ng\u00e0y tr\u01b0\u1edbc"):31536E6>c?(d=new Date(b),d="ng\u00e0y "+d.getDay()+", th\u00e1ng "+d.getMonth()):(d=new Date(b),d="ng\u00e0y "+d.getDay()+", th\u00e1ng "+d.getMonth()+", n\u0103m "+d.getFullYear());a.html(d)}};var SiteBackground=function(a,b){this.app=a;this.site=b};SiteBackground.prototype={Init:function(){self.modal=$('<div class="modal fade" role="dialog" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"></div></div></div>').modal({show:!1}).appendTo(self.form)}};var PageAjax=function(a){if("undefined"!=typeof a){"undefined"==typeof a.data&&(a.data={});var b=document.cookie.split(";");try{for(var c=0;c<=b.length;c++){var d=b[c].split("=");if("_xsrf"==d[0].trim()){var e=d[1].trim();a.data._xsrf=e;break}}}catch(g){}return $.ajax(a)}},Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(a){var b="",c,d,e,g,f,k,h=0;for(a=Base64._utf8_encode(a);h<a.length;)c=a.charCodeAt(h++),d=a.charCodeAt(h++),e=a.charCodeAt(h++),
g=c>>2,c=(c&3)<<4|d>>4,f=(d&15)<<2|e>>6,k=e&63,isNaN(d)?f=k=64:isNaN(e)&&(k=64),b=b+this._keyStr.charAt(g)+this._keyStr.charAt(c)+this._keyStr.charAt(f)+this._keyStr.charAt(k);return b},decode:function(a){var b="",c,d,e,g,f,k=0;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");k<a.length;)c=this._keyStr.indexOf(a.charAt(k++)),d=this._keyStr.indexOf(a.charAt(k++)),g=this._keyStr.indexOf(a.charAt(k++)),f=this._keyStr.indexOf(a.charAt(k++)),c=c<<2|d>>4,d=(d&15)<<4|g>>2,e=(g&3)<<6|f,b+=String.fromCharCode(c),
64!=g&&(b+=String.fromCharCode(d)),64!=f&&(b+=String.fromCharCode(e));return b=Base64._utf8_decode(b)},_utf8_encode:function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):(127<d&&2048>d?b+=String.fromCharCode(d>>6|192):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128)),b+=String.fromCharCode(d&63|128))}return b},_utf8_decode:function(a){for(var b="",c=0,d=c1=c2=0;c<a.length;)d=a.charCodeAt(c),128>d?(b+=String.fromCharCode(d),
c++):191<d&&224>d?(c2=a.charCodeAt(c+1),b+=String.fromCharCode((d&31)<<6|c2&63),c+=2):(c2=a.charCodeAt(c+1),c3=a.charCodeAt(c+2),b+=String.fromCharCode((d&15)<<12|(c2&63)<<6|c3&63),c+=3);return b}};
