PageModuleCineImport.prototype=new Module;PageModuleCineImport.prototype.constructor=PageModuleCineImport;function PageModuleCineImport(c){Module.call(this,c)}
PageModuleCineImport.prototype.Init=function(c){Module.prototype.Init.call(this,c);var b=this;b.modal=$('<div class="modal fade" role="dialog" aria-hidden="true" data-backdrop="static"><div class="dialog col-md-10 col-md-offset-1"><div class="modal-content"></div></div></div>').modal({show:!1}).appendTo(b.form);b.modal_content=b.modal.find(".modal-content");b.form.on("change",".movie-json",function(a){b._InfoClear();a=$(this).val();$(this).val(js_beautify(a,{indent_size:1,indent_char:"\t"}));a=$.parseJSON(a);
var f=b.form.find(".movie-info");$.each(a,function(a,d){if("chap"==a||"movie"==a){console.debug(d);var g="";$.each(d,function(b,a){var d="";$.each(a.server,function(b,a){var e="";$.each(a.part,function(b,a){a=$.extend({name:"unknown",link:"",source:[],cache:{}},a);var d=$('<div class="part name" part-link="'+a.link+'" part-source="'+Base64.encode(JSON.stringify(a.source))+'" part-cache="'+Base64.encode(JSON.stringify(a.cache))+'">'+a.name+"</div>");void 0!=a.link&&""!=a.link||d.attr("part-link","").addClass("alert");
e+=d[0].outerHTML});d+='<div class="server"><div class="name">'+a.name+'</div><div class="parts">'+e+"</div></div>"});g+='<div class="chap"><div class="name">'+a.name+'</div><div class="servers">'+d+"</div></div>"});b.form.find(".movie-chaps").html(g)}else{"array"==$.type(d)?d=d.join("\n"):"object"==$.type(d)&&(d=JSON.stringify(d));var c=f.find("[name="+a+"]").val("");c.is("textarea")&&(d=$("<textarea></textarea>").html(d).val());c.val(d)}});b._InfoView()});b.form.on("change",".movie-info [name]",
function(a){a=b._InfotoJson();b.form.find(".movie-json").val(js_beautify(JSON.stringify(a),{indent_size:1,indent_char:"\t"}));b._InfoView()});b.form.on("click",".movie-chaps .name",function(){b.__current_name_object=$(this);if(b.__current_name_object.is(".part")){var a=$('<div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><h4 class="modal-title">Update</h4></div><div class="modal-body"><div class="row"><div class="col-sm-12"><label>Name</label><input type="text" name="name" class="form-control"><label>Link</label><div class="input-group"><input type="text" class="form-control" name="link"><span class="input-group-btn"><button type="button" class="btn btn-default get-cache"><span class="glyphicon glyphicon-cloud-download"></span> Update Cache</button></span></div><label>Cache</label><textarea class="form-control input-sm" name="cache" rows="10"></textarea><label>Source</label><textarea class="form-control" name="source" rows="5"></textarea></div></div></div><div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Close</button><button type="button" class="btn btn-primary movie-update">Update</button></div>'),
f=b.__current_name_object.html(),e=b.__current_name_object.attr("part-link"),d=$.parseJSON(Base64.decode(b.__current_name_object.attr("part-source"))).join("\n"),g=js_beautify(Base64.decode(b.__current_name_object.attr("part-cache")));a.find("input[name=name]").val(f);a.find("input[name=link]").val(e);a.find("textarea[name=source]").val(d);a.find("textarea[name=cache]").val(g)}else a=$('<div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><h4 class="modal-title">Update</h4></div><div class="modal-body"><div class="row"><div class="col-sm-12"><label>Movie Name</label><input type="text" name="name" class="form-control"></div></div></div><div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Close</button><button type="button" class="btn btn-primary movie-update">Update</button></div>'),
f=b.__current_name_object.html(),a.find("input[name=name]").val(f);b.modal_content.html(a);b.modal.modal("show")});this.modal.on("click",".btn.get-cache",function(a){a=b.modal.find("input[name=link]").val();$.getJSON(a,function(a){var e={video:[],expire:0};$.each(a.feed.media.content,function(a,b){0==b.type.indexOf("video")&&(e.video.push(b),e.expire||(e.expire=parseInt(b.url.split("expire=")[1].split("&"))))});b.modal.find("textarea[name=cache]").val(js_beautify(JSON.stringify(e)))})});b.modal.on("click",
".modal-footer .movie-update",function(){if(void 0!=b.__current_name_object){if(b.__current_name_object.is(".part")){var a=b.modal_content.find("input[name=name]").val().trim(),c=b.modal_content.find("input[name=link]").val().trim(),e=b.modal_content.find("textarea[name=source]").val().trim(),d=b.modal_content.find("textarea[name=cache]").val().trim(),g=e.split("\n"),e=[];$.each(g,function(a,b){b=b.trim();0<b.length&&e.push(b)});console.debug(e);try{d=$.parseJSON(d)}catch(h){d={}}b.__current_name_object.html(a);
b.__current_name_object.attr("part-link",c);b.__current_name_object.attr("part-source",Base64.encode(JSON.stringify(e)));b.__current_name_object.attr("part-cache",Base64.encode(JSON.stringify(d)))}else a=b.modal_content.find("input[name=name]").val().trim(),b.__current_name_object.html(a);b.modal.modal("hide")}});var h=$('<div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><h4 class="modal-title">Import Movie</h4></div><div class="modal-body"><div class="row"><div class="col-sm-12"><label>Current Movie JSON</label><textarea class="form-control" name="movie-json" rows="25"></textarea></div></div></div><div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Close</button><button type="button" class="btn btn-primary movie-import">Import</button></div>');
b.form.on("click",".import",function(a){a=b._InfotoJson();a=js_beautify(JSON.stringify(a),{indent_size:1,indent_char:"\t"});h.find("[name=movie-json]").val(a);b.modal_content.html(h);b.modal.modal("show")});b.modal.on("click",".modal-footer .movie-import",function(){var a=b.modal_content.find("[name=movie-json]").val(),a=JSON.stringify($.parseJSON(a));b.Load({query:{action:"import",movie:a},callback:function(a){0==a.error&&b.modal.modal("hide")}})})};
PageModuleCineImport.prototype._InfoView=function(){var c=this.form.find(".movie-info"),b=this.form.find(".movie-viewer"),h=c.find("[name=poster]").val().trim();b.find(".poster").attr("src",h);c=c.find("[name=description]").val().trim();b.find(".description").html(c)};
PageModuleCineImport.prototype._InfotoJson=function(){var c={chap:[]},b=this.form.find(".movie-info [name]");$.each(b,function(b,a){a=$(a);var f=a.attr("name"),e=a.val();"length"==f&&(e=$.parseJSON(e));"description"!=f&&a.is("textarea")&&(tmp=e.split("\n"),e=[],$.each(tmp,function(b,a){a=a.trim();0<a.length&&e.push(a)}));c[f]=e});b=this.form.find(".movie-chaps");$.each(b.find(".chap"),function(b,a){a=$(a);var f={name:a.children(".name").html().trim(),server:[]};$.each(a.find(".servers .server"),function(a,
b){b=$(b);var c={name:b.children(".name").html().trim(),part:[]};$.each(b.find(".parts .part"),function(b,a){a=$(a);c.part.push({name:a.html().trim(),link:a.attr("part-link").trim(),source:$.parseJSON(Base64.decode(a.attr("part-source"))),cache:$.parseJSON(Base64.decode(a.attr("part-cache")))})});f.server.push(c)});c.chap.push(f)});return c};
PageModuleCineImport.prototype._InfoClear=function(){var c=this.form.find(".movie-info [name]");$.each(c,function(b,c){c=$(c);c.is("textarea")&&c.html("");c.val("")});this.form.find(".movie-chaps").html("")};
